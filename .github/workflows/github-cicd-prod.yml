name: Validate prod

on: [ push, workflow_dispatch ]

jobs:
  test-compose:
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3
      - name: üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose (–µ—Å–ª–∏ –Ω–∞–¥–æ)
        run: sudo apt-get install -y docker-compose
        # üî¥ –ù–∞ ubuntu-latest –æ–Ω–æ —É–∂–µ –µ—Å—Ç—å, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å
      - name: üöÄ –ó–∞–ø—É—Å–∫ docker-compose
        run: docker-compose -f prod/docker-compose.yml up -d
        # ‚ö†Ô∏è –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≤–∑–ª–µ—Ç–∏—Ç, workflow –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–π–¥—ë—Ç –¥–∞–ª—å—à–µ. –î–∞–≤–∞–π —Ñ–∏–∫—Å:
      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: docker-compose -f prod/docker-compose.yml up --exit-code-from dance-cup-ui
        # üî• –¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —Å–¥–æ—Ö, –≤–µ—Å—å workflow –æ—Ç–≤–∞–ª–∏—Ç—Å—è
      - name: üèÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã (–∂–¥—ë–º 10 —Å–µ–∫, –ø–æ—Ç–æ–º —Å–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏)
        run: |
          sleep 10  # ‚ö†Ô∏è –ö–æ—Å—Ç—ã–ª—å! –õ—É—á—à–µ healthcheck –∏–ª–∏ `wait-for-it`
          docker ps
          docker-compose -f prod/docker-compose.yml logs
      - name: üíÄ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        if: always()  # üî• –¢–µ–ø–µ—Ä—å –¥–∞–∂–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–¥—ë—Ç, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–∏–±—å—ë–º
        run: docker-compose -f prod/docker-compose.yml down
      - name: Notify success
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.ECC_TG_CHAT_ID }}
        run: |
          MESSAGE="‚úÖ –í—Å–µ –æ–±—Ä–∞–∑—ã **prod** –æ–∫—Ä—É–∂–µ–Ω–∏—è **dance-cup** —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
            -d chat_id=$TELEGRAM_CHAT_ID \
            -d text="$MESSAGE" \
            -d parse_mode=MarkdownV2
      - name: Notify failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="‚ùå –ù–µ –≤—Å–µ –æ–±—Ä–∞–∑—ã **prod** –æ–∫—Ä—É–∂–µ–Ω–∏—è **dance-cup** —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
            -d chat_id=$TELEGRAM_CHAT_ID \
            -d text="$MESSAGE" \
            -d parse_mode=MarkdownV2